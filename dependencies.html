<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dependencies</title>
    <style>
      body {
        background-color: black;
      }
      h1 {
        font-family: Arial, Helvetica, sans-serif;
        color: white;
        text-align: center;
      }
      canvas {
        background-color: #212121;
        display: block;
        margin: 20px auto;
      }
    </style>
  </head>
  <body>
    <h1>Job Dependencies</h1>
    <canvas></canvas>
    <script>
      const deps = [
        { name: "Start", dependencies: [], color: "#EC407A", strokeColor: "#EC407A" },

        { name: "Job1", dependencies: ["Start"], strokeColor: "#EC407A" },
        { name: "Job2", dependencies: ["Job1"] },
        { name: "Job3", dependencies: ["Job2"] },
        { name: "Job4a", dependencies: ["Job3"] },
        { name: "Job5a", dependencies: ["Job4a"] },
        { name: "Job5b", dependencies: ["Job4a"], color: "#AB47BC" },
        { name: "Job4b", dependencies: ["Job3"] },
        { name: "Job6a", dependencies: ["Job4b"] },
        { name: "Job6b", dependencies: ["Job4b"], color: "#AB47BC" },
        { name: "Job4c", dependencies: ["Job3"] },
        { name: "Job7a", dependencies: ["Job4c"] },
        { name: "Job7b", dependencies: ["Job4c"], color: "#AB47BC" },
        { name: "Job4d", dependencies: ["Job3"] },
        { name: "Job8a", dependencies: ["Job4d"] },
        { name: "Job8b", dependencies: ["Job4d"], color: "#AB47BC" },
        { name: "Job9", dependencies: ["Job5a"] },
        { name: "Job10", dependencies: ["Job9"] },
        { name: "Job11", dependencies: ["Job10"] },
        { name: "Job12", dependencies: ["Job11"] },
        { name: "Job13", dependencies: ["Job12"] },
        { name: "Job14", dependencies: ["Job13"] },
        { name: "Job5End", dependencies: ["Job14", "Job5b"] },

        { name: "Job15", dependencies: ["Job6a"] },
        { name: "Job16", dependencies: ["Job15"] },
        { name: "Job17", dependencies: ["Job16"] },
        { name: "LongJobnameToCropIt", dependencies: ["Job17"], color: "#5C6BC0" },
        { name: "Job19", dependencies: ["LongJobnameToCropIt"] },
        { name: "Job20", dependencies: ["Job19"] },
        { name: "Job21", dependencies: ["Job20"] },
        { name: "Job6End", dependencies: ["Job21", "Job6a"], color: "#42A5F5",strokeColor: "#42A5F5"},

        { name: "Job7a", dependencies: ["Job7b"] },
        { name: "Job18", dependencies: ["Job7a"] },
        { name: "Job19a", dependencies: ["Job18"] },
        { name: "Job20a", dependencies: ["Job19a"] },
        { name: "Job21a", dependencies: ["Job20a"] },

        { name: "Job22", dependencies: ["Job7a"] },
        { name: "Job23", dependencies: ["Job22"] },
        { name: "Job24", dependencies: ["Job23"] },
        { name: "Job7End", dependencies: ["Job24", "Job7a"] },

        { name: "Job25", dependencies: ["Job8a"] },
        { name: "Job26", dependencies: ["Job25"] },
        { name: "Job27", dependencies: ["Job26"] },
        { name: "Job28", dependencies: ["Job27"] },
        { name: "Job29", dependencies: ["Job28"] },
        { name: "Job30", dependencies: ["Job29"] },
        { name: "Job31", dependencies: ["Job30"] },
        { name: "Job32", dependencies: ["Job31"] },
        { name: "Job33", dependencies: ["Job32"] },
        { name: "Job34", dependencies: ["Job33"] },
        { name: "Job35", dependencies: ["Job34"] },
        { name: "Job36", dependencies: ["Job35"] },
        { name: "Job37", dependencies: ["Job36"] },
        { name: "Job38", dependencies: ["Job37"] },
        { name: "Job39", dependencies: ["Job38"] },
        { name: "Job8End", dependencies: ["Job39", "Job8a"] },

        { name: "End", dependencies: ["Job5End", "Job6End", "Job7End", "Job8End","Start"], color: "#EC407A" },
      ];

      const canvas = document.querySelector("canvas");
      const ctx = canvas.getContext("2d");

      const boxWidth = 150;
      const boxHeight = 50;
      const horizontalSpacing = 60;
      const verticalSpacing = 30;

      // Calculate positions for each job dynamically
      const positions = {};
      const levels = {};

      // Assign levels to jobs based on dependencies
      deps.forEach((job) => {
        if (job.dependencies.length === 0) {
          levels[job.name] = 0; // Root level
        } else {
          levels[job.name] = Math.max(...job.dependencies.map((dep) => levels[dep] || 0)) + 1;
        }
      });

      // Group jobs by levels
      const jobsByLevel = Object.entries(levels).reduce((acc, [job, level]) => {
        acc[level] = acc[level] || [];
        acc[level].push(job);
        return acc;
      }, {});

      // Calculate the required canvas size
      const maxLevel = Math.max(...Object.values(levels));
      const maxJobsInLevel = Math.max(...Object.values(jobsByLevel).map((jobs) => jobs.length));
      const canvasWidth = maxJobsInLevel * (boxWidth + horizontalSpacing) + 50; // Add padding
      const canvasHeight = (maxLevel + 1) * (boxHeight + verticalSpacing) + 50; // Add padding

      // Set the canvas size dynamically
      canvas.width = canvasWidth;
      canvas.height = canvasHeight;

      // Assign positions based on levels and order within levels
      Object.entries(jobsByLevel).forEach(([level, jobs]) => {
        jobs.forEach((job, index) => {
          const x = 50 + index * (boxWidth + horizontalSpacing); // Add padding
          const y = 50 + level * (boxHeight + verticalSpacing); // Add padding
          positions[job] = { x, y };
        });
      });

      // Function to draw an arrowhead at the start of the line
      function drawArrowhead(ctx, fromX, fromY, toX, toY, arrowSize, color) {
        const angle = Math.atan2(toY - fromY, toX - fromX); // Calculate the angle of the line

        // Coordinates for the two sides of the arrowhead
        const arrowX1 = fromX + arrowSize * Math.cos(angle - Math.PI / 6);
        const arrowY1 = fromY + arrowSize * Math.sin(angle - Math.PI / 6);
        const arrowX2 = fromX + arrowSize * Math.cos(angle + Math.PI / 6);
        const arrowY2 = fromY + arrowSize * Math.sin(angle + Math.PI / 6);

        // Draw the arrowhead
        ctx.beginPath();
        ctx.moveTo(fromX, fromY); // Tip of the arrow
        ctx.lineTo(arrowX1, arrowY1); // Left side of the arrowhead
        ctx.lineTo(arrowX2, arrowY2); // Right side of the arrowhead
        ctx.closePath();
        ctx.fillStyle = color; // Arrow color
        ctx.fill();
      }

      function cropJobNameText(jobname) {
        const maxLength = 17; // Maximum length of the job name
        if (jobname.length > maxLength) {
          return jobname.substring(0, maxLength - 3) + "..."; // Crop and add ellipsis
        }
        return jobname; // Return original name if within limit
      }

      // Draw the jobs and dependencies
      function drawDependencies() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw boxes for jobs first
        deps.forEach((job) => {
          const { x, y } = positions[job.name];
          ctx.fillStyle = "#212121"; // Use job color or default
          ctx.fillRect(x, y, boxWidth, boxHeight);
          ctx.strokeStyle = job.color ? job.color : "#78909C";
          ctx.strokeRect(x, y, boxWidth, boxHeight);
          ctx.fillStyle = job.color ? job.color : "#78909C";
          ctx.font = "bold 16px Arial";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(cropJobNameText(job.name), x + boxWidth / 2, y + boxHeight / 2);
        });

        // Draw lines for dependencies after the boxes
        deps.forEach((job) => {
          const { x: startX, y: startY } = positions[job.name];
          const lineColor = job.strokeColor ? job.strokeColor : "rgba(126, 87, 194,0.5)"; // Use job stroke color or default

          job.dependencies.forEach((dep, index) => {
            const { x: endX, y: endY } = positions[dep];

            // Offset the line slightly based on the index of the dependency
            const offset = (index - job.dependencies.length / 2) * 10; // Adjust offset dynamically

            // Draw the line
            ctx.beginPath();
            ctx.moveTo(startX + boxWidth / 2 + offset, startY); // Start with an offset
            ctx.lineTo(endX + boxWidth / 2 + offset, endY + boxHeight); // End with the same offset
            ctx.strokeStyle = lineColor; // Set line color based on dependency count
            ctx.lineWidth = 1; // Make the lines more visible
            ctx.stroke();

            // Draw the arrowhead at the start of the line
            drawArrowhead(
              ctx,
              startX + boxWidth / 2 + offset,
              startY,
              endX + boxWidth / 2 + offset,
              endY + boxHeight,
              10,
              lineColor
            );
          });
        });
      }

      drawDependencies();
    </script>
  </body>
</html>
